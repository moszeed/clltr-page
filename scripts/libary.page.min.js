!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.libary=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module){!function(){"use strict";var embedlyUrl="https://api.embed.ly/1/extract?key=35550e76c44048aa92ca559f77d2fd1e&format=json&url=",request=require("xhr"),_=require("underscore"),Helper=require("helper"),Backbone=require("drbx-js-backbone"),PromiseCache={},activateCache=!0,saveContent=!0,Items=module.exports;Items.Model=Backbone.Model.extend({defaults:{name:null,description:null,provider:null,providerUrl:null,type:"link",created:null,listId:[],tags:[],height:null,url:null,urlCache:null,faviconUrl:null,faviconUrlCache:null,previewImageUrl:null,previewImageUrlCache:null},initialize:function(){_.bindAll(this,"addListById","formatEmbedlyData","refreshData","getUrlData","setFaviconToCache","setPreviewImageToCache","setImageToCache")},getUrlData:function(url){return new Promise(function(resolve,reject){if(!url||null===url)throw new Error("no url given");request({uri:embedlyUrl+url,json:!0},function(err,response,body){err?reject(err):resolve(body)})})},setFileToUrl:function(url,path){if(!url)throw new Error("no url given");if(!path)throw new Error("no path given");return PromiseCache["setFileToUrl"+path]?Promise.resolve():(PromiseCache["setFileToUrl"+path]=new Promise(function(resolve,reject){var saveUrlError=function(err){console.log(err),reject(err)},saveUrl=function(){return Backbone.DrbxJs.saveUrl(url,path).then(resolve)["catch"](saveUrlError)};PromiseCache["setFileToUrl"+path]=Backbone.DrbxJs.metadata(path).then(function(responseMeta){responseMeta.isRemoved?saveUrl():resolve()})["catch"](saveUrl)}),PromiseCache["setFileToUrl"+path])},setFaviconToCache:function(params){return params.faviconUrl&&params.provider?(params.faviconUrlCache="/cache/"+params.provider+".ico",this.setFileToUrl(params.faviconUrl,params.faviconUrlCache).then(function(){return params})):Promise.resolve(params)},setImageToCache:function(params){var that=this;if("image"!==params.type)return Promise.resolve(params);var imageFilename=Helper.getFilenameFromUrl(that.get("url"));return params.urlCache="/cache/images/"+params.provider+"/"+Date.now()+"_"+imageFilename,this.setFileToUrl(that.get("url"),params.urlCache).then(function(){return params})},setPreviewImageToCache:function(params){return"video"===params.type||params.previewImageUrl?(params.previewImageUrlCache="/cache/images/"+params.provider+"/"+Date.now()+"_"+params.name,this.setFileToUrl(params.previewImageUrl,params.previewImageUrlCache).then(function(){return params})):Promise.resolve(params)},formatEmbedlyData:function(pageData){pageData=pageData||{};var params={name:pageData.title||this.get("url"),type:pageData.type||"link",description:pageData.description||"",provider:pageData.provider_name,providerUrl:pageData.provider_url,faviconUrl:pageData.favicon_url||null,created:Date.now()};return"html"===pageData.type&&(params.type="link"),"error"===pageData.type&&(params.type="link"),pageData.media&&"html"===pageData.type&&("video"===pageData.media.type&&(params.name=Helper.getFilenameFromUrl(this.get("url")),params.type="video","YouTube"===params.provider&&(params.name=params.name.substring(params.name.lastIndexOf("=")+1)),0!==pageData.images.length&&(params.previewImageUrl=pageData.images[0].url)),"photo"===pageData.media.type&&(params.type="image",params.height=pageData.media.height||null),"rich"===pageData.media.type&&-1!==this.get("url").indexOf("soundcloud")&&(params.type="audio")),"image"===pageData.type&&"photo"===pageData.media.type&&(params.type="image",params.height=pageData.media.height||null),params},refreshData:function(opts){opts=opts||{},opts.activateCache||(opts.activateCache=activateCache),opts.saveContent||(opts.saveContent=saveContent);var that=this;return this.getUrlData(this.get("url")).then(function(data){var formattedData=that.formatEmbedlyData(data);that.set(formattedData);var promises=[];return opts.activateCache&&(promises.push(that.setFaviconToCache(formattedData)),promises.push(that.setPreviewImageToCache(formattedData))),opts.saveContent&&promises.push(that.setImageToCache(formattedData)),Promise.all(promises).then(function(responseData){var setData=_.extend(responseData[0],responseData[1],responseData[2]);that.set(setData)}).then(function(){return that})["catch"](function(err){console.log("cache fail"),console.log(err)})})},addListById:function(listId){if(!listId&&0===listId.length)throw new Error("no listId");var listIds=this.get("listId");-1===_.indexOf(listIds,listId)&&(listIds.push(listId),this.set({listId:listIds}))}}),Items.Collection=Backbone.Collection.extend({url:"items",model:Items.Model,initialize:function(){_.bindAll(this,"save")},addAndGetData:function(params,opts){params=params||{},opts=opts||{};var model=this.add(params);return model.refreshData(opts)},search:function(inputString){return _.compact(this.map(function(listItem){return-1!==listItem.get("url").indexOf(inputString)||-1!==listItem.get("name").indexOf(inputString)||-1!==listItem.get("description").indexOf(inputString)?listItem:void 0}))},save:function(){if(0===this.models.length)return Promise.resolve();var responsePromise=null;return this.each(function(model){responsePromise=model.save()}),responsePromise}})}()},{"drbx-js-backbone":"drbx-js-backbone",helper:"helper",underscore:"underscore",xhr:"xhr"}],2:[function(require,module){!function(){"use strict";var _=require("underscore"),Backbone=require("drbx-js-backbone"),Lists=module.exports;Lists.Model=Backbone.Model.extend({defaults:{id:null,name:null,description:null,totalCount:0},initialize:function(){_.bindAll(this,"refreshTotalCount")},refreshTotalCount:function(collection){if(!collection)throw new Error("no collection");var filterResult=collection.filter(function(itemModel){return-1!==_.indexOf(itemModel.get("listId"),this.get("id"))}.bind(this));this.set({totalCount:filterResult.length})}}),Lists.Collection=Backbone.Collection.extend({url:"lists",model:Lists.Model,comparator:function(model){return model.get("name")},initialize:function(){_.bindAll(this,"save")},save:function(){if(0===this.models.length)return Promise.resolve();var responsePromise=null;return this.each(function(model){responsePromise=model.save()}),responsePromise}})}()},{"drbx-js-backbone":"drbx-js-backbone",underscore:"underscore"}],3:[function(require,module){!function(){"use strict";var Helper=require("helper"),Backbone=require("drbx-js-backbone");Backbone.init({client:{key:"38sn4xw32xtxi32"},auth:new Backbone.DrbxJs.Dropbox.AuthDriver.Popup({receiverUrl:Helper.getCurrentUrl(),rememberUser:!0})});var User={};User.Model=Backbone.Model.extend({login:function(params){return params=params||{},params.token?Backbone.init({client:{token:params.token}}):Backbone.login().then(function(){localStorage.setItem("alreadyAuthenticated","true")})},logout:function(){localStorage.clear()},isLoggedIn:function(){var isAuthenticated=Backbone.DrbxJs.Client.isAuthenticated();return isAuthenticated||localStorage.getItem("alreadyAuthenticated")&&(this.login(),isAuthenticated=!0),isAuthenticated}}),module.exports=new User.Model}()},{"drbx-js-backbone":"drbx-js-backbone",helper:"helper"}],4:[function(require,module){!function(){"use strict";var $=require("jquery"),Backbone=require("backbone");Backbone.View=require("backbone-template");var Widget=module.exports;Widget.Content=Backbone.View.extend({id:"widgetContent",render:function(widget,params){return params=params||{},new Promise(function(resolve){this.template({path:"./templates/widgets/"+widget+".widget.html",params:params,success:function(){resolve()}})}.bind(this))}}),Widget.View=Backbone.View.extend({id:"widget",events:{"click .close":function(){this.remove()}},render:function(widget,params){return $("#widget").remove(),this.vWidgetContent=new Widget.Content,this.$el.html("<div id='widgetOverlay'></div>"),this.vWidgetContent.$el.appendTo(this.$el),this.$el.css("display","block"),this.$el.appendTo("body"),this.vWidgetContent.render(widget,params)}})}()},{backbone:"backbone","backbone-template":"backbone-template",jquery:"jquery"}],5:[function(require){!function(){"use strict";function getFaviconUrl(model){return model.get("faviconUrlCache")?ApiGetFileUrl+Backbone.DrbxJs.Client._urlEncodePath(model.get("faviconUrlCache"))+"?access_token="+Backbone.DrbxJs.Client._oauth._token:model.get("faviconUrl")}function getImageUrl(model){return"image"===model.get("type")?model.get("urlCache")?ApiGetFileUrl+Backbone.DrbxJs.Client._urlEncodePath(model.get("urlCache"))+"?access_token="+Backbone.DrbxJs.Client._oauth._token:model.get("url"):"video"===model.get("type")?model.get("previewImageUrlCache")?ApiGetFileUrl+Backbone.DrbxJs.Client._urlEncodePath(model.get("previewImageUrlCache"))+"?access_token="+Backbone.DrbxJs.Client._oauth._token:model.get("previewImageUrl"):void 0}function isElementInViewport(el){"function"==typeof jQuery&&el instanceof jQuery&&(el=el[0]);var rect=el.getBoundingClientRect();return rect.top>=-100&&rect.left>=0&&rect.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&rect.right<=(window.innerWidth||document.documentElement.clientWidth)}var $=require("jquery"),_=require("underscore"),Backbone=require("drbx-js-backbone"),Helper=require("helper"),Widget=require("../modules/widget.module.js"),User=require("../modules/user.module.js"),Lists=require("../modules/lists.module.js"),Items=require("../modules/items.module.js"),cItems=new Items.Collection,cLists=new Lists.Collection,ApiGetFileUrl=Backbone.DrbxJs.Client._urls.getFile+"/";if(!User.isLoggedIn())throw new Error("not logged in");var Libary={};Libary.Events=_.extend({},Backbone.Events),Libary.EditLists=Widget.View.extend({events:{"change .listItem :input":function(el){var $el=$(el.target),$parent=$el.parent(),keyName=$el.attr("class"),listId=$parent.attr("class").split(" ")[1],listModel=cLists.get(listId);listModel.set(keyName,$el.val()),listModel.save()},"click .close":function(){this.remove()},"click #addListItem .addItem":function(){var $addListItem=this.$el.find("#addListItem");""!==$addListItem.find("input").val()&&(cLists.add({name:$addListItem.find("input").val(),description:$addListItem.find("textarea").val()}),$addListItem.find(":input").val(""),this.showLists()),cLists.save().then(function(){this.showLists()}.bind(this))},"click .listItem .removeItem":function(el){var $el=$(el.target),$parent=$el.parent(),listId=$parent.attr("class").split(" ")[1],mList=cLists.get(listId);return 0!==mList.get("totalCount")?void alert("list not empty"):(cLists.remove(listId),void this.showLists())}},showLists:function(){var tpl=_.template("<div class='listItem <%= id%>'><input class='name' value='<%= name %>'><textarea class='description'><%= description%></textarea><button class='removeItem'>remove</button></div>"),listItems=[];cLists.each(function(listModel){listItems.push(tpl(listModel.pick("id","name","description")))}),this.$el.find("#availableLists").html(listItems.join(""))},initialize:function(){_.bindAll(this,"showLists"),this.render("editlists").then(this.showLists)}}),Libary.EditItem=Widget.View.extend({events:{"click .close":function(){this.remove()},"click .delete":function(){this.remove()},"change .list_data select":function(el){var $option=$(el.target).find(":selected"),listId=$option.attr("id");if(!listId)throw new Error("no listId");this.model.save({listId:[listId]})}},loadUrl:function(url,saveContent){cItems.addAndGetData({url:url},{saveContent:saveContent||!0}).then(function(model){this.model=model}.bind(this)).then(this.refresh).then(cItems.save)["catch"](function(err){console.log(err)})},refresh:function(){if(!this.model)throw new Error("no model given");this.render("edititem",{lists:cLists.toJSON(),attributes:_.extend(this.model.toJSON(),{faviconUrl:getFaviconUrl(this.model)})})},initialize:function(){_.bindAll(this,"loadUrl","refresh")}}),Libary.DeleteItem=Widget.View.extend({events:{"click .close":function(){this.remove()},"click .delete":function(){var collection=this.model.collection;this.model.destroy(),collection.save(),this.remove()}},initialize:function(){this.render("deleteItem")}}),Libary.Search=Backbone.View.extend({el:"#search_results",events:{"click .searchItem":function(el){Libary.Events.trigger("itemSelected",$(el.currentTarget).attr("id")),this.hide()},"click button":function(){var urlToAdd=$("#actions .search").val(),saveContent=this.$el.find(".addNew input").is(":checked"),editItemWidget=new Libary.EditItem;editItemWidget.loadUrl(urlToAdd,saveContent),this.hide()}},hide:function(){this.$el.css("display","none"),this.$el.html("")},render:function(inputString){this.$el.css("display","block");var addTpl='<div class="addNew"><button>add</button><input type="checkbox" checked="true"><span>save content (image) to Dropbox</span></div>',searchResult=cItems.search(inputString);if(0===searchResult.length)return void this.$el.html(addTpl);var searchResultElements=_.map(searchResult,function(searchItem){return'<div id="'+searchItem.get("id")+'" class="searchItem"><span>'+Helper.truncate(searchItem.get("url"),40,"..")+'</span><span class="description">'+Helper.truncate(searchItem.get("description"),40,"..")+"</span></div>"});this.$el.html(searchResultElements.join(""))}}),Libary.Item=Backbone.View.extend({events:{"click .name":function(){var win=window.open(this.model.get("url"),"_blank");return win.focus(),!1},"click .extend_me":function(){var $extend=this.$el.find(".extend"),displayAction=$extend.is(":visible")?"none":"block";$extend.css("display",displayAction)},"click .control .edit":function(){var widget=new Libary.EditItem({model:this.model});widget.refresh()},"click .control .delete":function(){new Libary.DeleteItem({model:this.model})}},className:function(){return"listItem "+this.model.get("type")+" "+this.model.get("id")},loadSrcByUserViewPort:function(){var $img=this.$el.find(".loader");if(0!==$img.length&&isElementInViewport(this.$el[0])){var $nImg=$(document.createElement("img"));$nImg.addClass("media_content"),$nImg.one("load",function(){$img.replaceWith($nImg)}),$nImg.attr("src",getImageUrl(this.model))}},initialize:function(){_.bindAll(this,"loadSrcByUserViewPort"),this.listenTo(this.model,"sync",function(){this.render()}.bind(this))},render:function(){var type=this.model.get("type");null===type&&(type="link");var typeName=type+"Item",fullPath="./templates/pages/libary/libary."+typeName+".html";this.$el.removeClass("locked"),this.model.get("id")||this.$el.addClass("locked");var params=_.extend({},this.model.toJSON(),{faviconUrl:getFaviconUrl(this.model),dateFormated:Helper.timeConverter(this.model.get("created")),name_truncated:Helper.truncate(this.model.get("name"),100)});this.template({path:fullPath,params:params,success:this.loadSrcByUserViewPort})}}),Libary.List=Backbone.View.extend({className:function(){return"list "+this.model.get("id")},initialize:function(){_.bindAll(this,"saveTotalCount","checkItems");var that=this;that.itemViews=[],that.listenTo(that.model,"change:id",function(){that.$el.removeClass().addClass(that.className())}),that.collection=new(Backbone.Collection.extend({comparator:function(model){return model.get("url")}})),that.listenTo(that.collection,"add",function(model){that.addItem(model),that.saveTotalCount()}),that.listenTo(that.collection,"remove",function(){that.removeItem(),that.saveTotalCount()}),that.render()},moveItem:function(model){this.removeItem(model),this.trigger("moveItem",model)},removeItem:function(model){if(!model)throw new Error("no model given");var filterResponse=_.filter(this.itemViews,function(itemView){return itemView.model.get("id")===model.get("id")});_.each(filterResponse,function(view){view.remove()})},addItem:function(model){if(!model)throw new Error("no model given");var viewItem=new Libary.Item({model:model});viewItem.$el.prependTo(this.$el.find(".content")),viewItem.render(),this.listenTo(viewItem.model,"change:listId",this.moveItem),this.itemViews.push(viewItem),$("#libary .no_content").css("display","none"),this.$el.css("display","inline-block")},saveTotalCount:function(){this.model.set({totalCount:this.collection.length}),this.model.save()},checkItems:function(){_.each(this.itemViews,function(itemView){itemView.loadSrcByUserViewPort()})},render:function(){var that=this;return new Promise(function(resolve){this.template({path:"./templates/pages/libary/libary.list.html",params:this.model.toJSON(),success:function(){that.$el.find(".content").off().on("scroll",_.debounce(function(){that.checkItems()},100)),resolve()}})}.bind(this))}}),Libary.Lists=Backbone.View.extend({el:"#libary #lists",unsortedId:"unsorted",initialize:function(){_.bindAll(this,"addList","addListForUnsortedItems","addItemToList","refresh","render","checkLists"),this.listItems=[],this.listenTo(cLists,"add",this.addList),this.listenTo(cItems,"add",this.addItemToList),this.$el.off().on("scroll",this.checkLists)},checkLists:_.debounce(function(){_.each(this.listItems,function(listView){listView.checkItems()})},100),addList:function(model){var view=new Libary.List({model:model});return view.$el.appendTo(this.$el),this.listenTo(view,"moveItem",this.moveListItem),this.listItems.push(view),view.render()},moveListItem:function(model){this.addItemToList(model)},addListForUnsortedItems:function(){var hasUnsortedItem=_.filter(this.listItems,function(listItem){return listItem.model.get("unsorted")});0===hasUnsortedItem.length&&this.addList(new Lists.Model({id:this.unsortedId,name:"unsorted",description:"unsorted list"}))},addItemToList:function(model){var listId=_.first(model.get("listId"));listId||(listId=this.unsortedId);var listViews=_.filter(this.listItems,function(listItem){return listItem.model.get("id")===listId});_.each(listViews,function(listView){listView.collection.add(model)})},refresh:function(){return this.addListForUnsortedItems(),cLists.fetch()["catch"](function(err){throw new Error(err)})},render:function(){var promises=[];return 0!==cLists.length&&cLists.forEach(function(model){promises.push(this.addList(model))}.bind(this)),Promise.all(promises)}}),Libary.Head=Backbone.View.extend({el:"#head",events:{"keyup #actions .search":function(el){var searchString=$(el.target).val();searchString.length>=1?this.vSearch.render(searchString):this.vSearch.hide()}},initialize:function(){this.vSearch=new Libary.Search}}),Libary.Sidebar=Backbone.View.extend({el:"#sidebar",events:{"click #lists .listItem":function(el){var value=$(el.target).attr("id");value||(value=$(el.target).parent().attr("id")),this.trigger("listSelected",value)},"click #lists_actions .edit":function(){this.editListWidget=new Libary.EditLists}},initialize:function(){this.listenTo(cLists,"sync",this.render)},render:function(){var $empty_lists=this.$el.find("#empty_lists div");$empty_lists.html("");var $list=this.$el.find("#lists");$list.html(""),cLists.each(function(listItem){0!==listItem.get("totalCount")&&$list.append('<div id="'+listItem.get("id")+'" class="listItem"><div class="listIcon"></div><span>'+listItem.get("name")+"</span></div>")})}}),Libary.View=Backbone.View.extend({initialize:function(){function doBounce(element,times,distance,speed){for(var i=0;times>i;i++)element.animate({marginTop:"-="+distance},speed).animate({marginTop:"+="+distance},speed)}_.bindAll(this,"refresh","render"),this.vHead=new Libary.Head,this.vLists=new Libary.Lists,this.vSidebar=new Libary.Sidebar,this.listenTo(Libary.Events,"itemSelected",function(itemId){var selectedItem=cItems.findWhere({id:itemId}),listId=selectedItem.get("listId")[0]||null;listId&&this.vSidebar.trigger("listSelected",listId)}),this.listenTo(this.vSidebar,"listSelected",function(listId){var $lists=$("#libary #lists"),$list=$lists.children(".list."+listId);$lists.animate({scrollLeft:$list.position().left},500),doBounce($list,2,"5px",200)}),this.refresh()},refreshList:function(){return this.vLists.refresh()["catch"](function(err){console.log("[err] fail to load list:"+err)})},refresh:function(){return this.refreshList().then(function(){return cItems.fetch()})["catch"](function(err){console.log("[err] fail to refresh: ",err),$("#libary .no_content").css("display","block")})}}),Libary.current=new Libary.View}()},{"../modules/items.module.js":1,"../modules/lists.module.js":2,"../modules/user.module.js":3,"../modules/widget.module.js":4,"drbx-js-backbone":"drbx-js-backbone",helper:"helper",jquery:"jquery",underscore:"underscore"}]},{},[5])(5)});